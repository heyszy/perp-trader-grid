# 原仓库网格策略逻辑提取与优化讨论

## 参考来源

- `perp-dex-trader/apps/bot/src/strategies/grid/grid-strategy.ts`
- `perp-dex-trader/apps/bot/src/state/grid/grid-state.ts`
- `perp-dex-trader/apps/bot/src/services/grid-order-manager.ts`
- `perp-dex-trader/apps/bot/src/utils/grid-env.ts`

## 现有策略逻辑提取

### 网格区间与触发

- 网格间距为绝对价格差 `GRID_SPACING`，单边档位数为 `GRID_LEVELS`。
- 使用 `GRID_SHIFT_TRIGGER_LEVELS` 构造“内层区间”，当价格进入内层边界外时触发平移。
- `GridStrategy` 仅负责区间计算与超界判断，平移步数在 `GridOrderManager` 中计算。

### 网格档位结构

- 0 档位默认不挂单，仅作为成交后反向挂单落点。
- 负档位为 BUY，正档位为 SELL。
- `GridState.shiftCenter` 在平移时按步数重映射档位与订单：
  - 档位 `targetSide` 继承旧档位，保持“滚动网格”状态。
  - 超出范围的订单标记为待撤单并保留状态追踪。

### 下单与撤单策略

- 初始化时以 mid 作为中心价，按档位挂满对称订单。
- 行情驱动：每次行情更新判断是否需要平移，否则补缺失订单。
- 成交处理：成交档位停止补单，相邻档位改为反向挂单。
- post-only 保护：若穿价则跳过下单等待下一次行情。

### 风控与对账

- 基于 `GRID_MAX_POSITION` 与 `GRID_MAX_OPEN_ORDERS` 做下单限制。
- 每 5s 对账一次，补齐 WS 漏单或 UNKNOWN 状态。
- 撤单超时仅对 ACKED 订单生效，过期或撤单失败会更新状态。

## 合理性评估

优势：

- 策略简单，行为可预测，适合初期迁移与验证。
- 平移机制可在趋势行情中维持网格跟随，减少脱离行情区间。
- 对账与状态机完整，具备断线与漏单的恢复能力。
- post-only 保护减少被动成交与交易所拒单风险。

潜在风险或不一致点：

- 使用 mid 作为中心价与触发依据，在大点差或低流动性时可能不稳定。
- 绝对价差网格在不同价位区间的相对密度差异较大，低价更密、高价更稀。
- 平移时继承 `targetSide` 会产生“非对称网格”，可能累积方向性仓位。
- 平移步数过大时仍采用“滚动平移”，未执行全量重建，存在状态继承偏差风险。
- post-only 只做跳过，不做价格修正，可能在剧烈行情下长时间空档。

## 已明确的需求方向

- 中心价使用 mark 价格作为锚点。
- 增加百分比间距选项，用户可选择绝对价差网格或百分比网格。
- 百分比网格采用几何百分比：`price_i = center * (1 + p)^i`。
- 价格每跨一档就触发平移。

## 拟采用的对称滑动网格方案

### 核心思路

- 始终保持“下 N 档 BUY、上 N 档 SELL”的对称结构。
- 平移仅改变中心价与档位价格，不继承旧档位的 `targetSide`。
- 成交仅更新订单状态，不改变目标挂单方向。

### 平移与重建规则

- 计算跨档步数 `steps`，当 `steps !== 0` 时执行平移。
- 若 `abs(steps) >= levels`，直接执行“全量重建”以避免状态继承偏差。
- 平移后重新计算每一档位的目标方向，并撤掉不符合目标方向或超出范围的订单。

### 跨档步数计算

- 绝对价差网格：
  - `steps = floor(|mark - center| / spacing)`，方向由 `mark` 相对 `center` 决定。
- 几何百分比网格：
  - 上涨：`steps = floor(log(mark / center) / log(1 + p))`
  - 下跌：`steps = -floor(log(center / mark) / log(1 + p))`

## 价格瞬间击穿的处理建议

- 单次行情更新可一次性平移多档，避免“来不及平移”的问题。
- 当 `abs(steps) >= levels` 时，直接执行全量重建：
  - 撤销所有未终态订单
  - 以最新 mark 作为中心价重新构建对称网格
  - 补齐上下档位的挂单
- 若 `abs(steps)` 较小，走“平移 + 局部补单”，减少撤单压力。

## 可优化空间（讨论项）

### 1. 网格密度与中心价

- 可选方案：提供“绝对价差/百分比间距”两种模式。
- 可选方案：中心价使用 mark 价格，必要时引入短期均值平滑（避免短期抖动）。
- 影响：更适合不同价格区间，但需要与最小步长取整逻辑配合。

### 2. 平移策略

- 增加“最小平移间隔”或“阈值滞回”，减少频繁平移造成的撤单风暴。
- 当平移步数超过阈值时执行全量重建，避免继承状态偏差。
- 平移后可重置 `targetSide` 为默认对称网格，减少方向偏置。
- 可选方案：改为“直接重建”而非滚动平移，保证状态一致性。

### 3. 成交后挂单逻辑

- 当前仅在相邻档位挂反向单，可能形成单边累积。
- 可选方案：根据净仓位调整 targetSide（网格偏置）。
- 可选方案：成交后同时补回原档位或更远档位，提升回补速度。

### 4. 下单与撤单执行

- post-only 保护可改为“就近价修正”，例如贴近最佳价减一档。
- 引入节流/批量操作策略，降低高频波动时的 API 压力。
- 针对 UNKNOWN 状态引入单独的保守策略，避免长时间占用挂单额度。

## 需要确认的关键问题

### 关于“方向偏置”的定义

- 当价格持续上行或下行时，成交后的反向补单机制会让网格逐步在某一方向累积挂单或持仓。
- 例如连续上行后，卖单被逐步成交，系统在更高档位继续挂卖，长期来看净仓位偏空或偏多。
- 这并非错误，但会让网格从“对称中性”转向“趋势偏置”，风险与收益特征都会变化。

### 需要确认的问题

- 是否允许网格在趋势行情中形成方向性偏置，还是保持对称为主？
- 百分比网格的计算方式：线性百分比（`center * (1 ± n*p)`）还是几何百分比（`center * (1 ± p)^n`）？
- 平移策略采用“滚动平移 + 继承状态”还是“越界即重建”？
- 平移触发阈值、最小平移间隔、重建阈值如何设定？
- 对于 post-only 被穿价的场景，是否允许价格修正后仍下单？
